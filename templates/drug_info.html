<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aditi - Pharmaceutical Assistant</title>
  <link rel="stylesheet" href="../static/css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>Aditi - Your Pharmaceutical Assistant</h1>

    <div id="chatbox" class="message-container"></div>
    <div class="input-container">
      <input type="text" id="userInput" placeholder="Ask Aditi..." autofocus />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Profile Section -->
  <div class="profile-container">
    <button id="profileButton" onclick="toggleProfileMenu()">Profile</button>
    <div id="profileMenu" class="profile-menu">
      <div>Name: <span id="loggedUserFName"></span> <span id="loggedUserLName"></span></div>
      <div>Email: <span id="loggedUserEmail"></span></div>
      <p></p>
      <button id="logout">Logout</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>

  <!-- Main Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDa6_47neFJAH-I4i-ZCU0elY4cRmpyotg",
      authDomain: "aditi-pharmaceutical-assistant.firebaseapp.com",
      projectId: "aditi-pharmaceutical-assistant",
      storageBucket: "aditi-pharmaceutical-assistant.appspot.com",
      messagingSenderId: "241653252150",
      appId: "1:241653252150:web:ce83fa898dc2f77a669897",
      measurementId: "G-HMJ6SD9Q9H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const userData = docSnap.data();
            document.getElementById('loggedUserFName').innerText = userData.firstName || "";
            document.getElementById('loggedUserLName').innerText = userData.lastName || "";
            document.getElementById('loggedUserEmail').innerText = userData.email || "";
          } else {
            window.location.href = "/";
          }
        } catch (err) {
          console.error("Error fetching user data:", err);
          window.location.href = "/";
        }
      } else {
        window.location.href = "/";
      }
    });

    // Logout functionality
    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logout');
      if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          signOut(auth)
            .then(() => {
              localStorage.removeItem('loggedInUserId');
              window.location.href = "/";
            })
            .catch((error) => console.error("Sign out error:", error));
        });
      }

      // Chat handling
      const sendBtn = document.getElementById("sendBtn");
      sendBtn.addEventListener("click", async () => {
        const inputField = document.getElementById("userInput");
        const input = inputField.value.trim();
        if (!input) return;

        const chatbox = document.getElementById("chatbox");

        // Show user message
        const userMsg = document.createElement("div");
        userMsg.className = "user-message";
        userMsg.textContent = input;
        chatbox.appendChild(userMsg);
        inputField.value = "";

        // Show typing...
        const typingMsg = document.createElement("div");
        typingMsg.className = "bot-message";
        typingMsg.textContent = "Aditi is thinking...";
        chatbox.appendChild(typingMsg);
        chatbox.scrollTop = chatbox.scrollHeight;

        try {
          const response = await fetch("/get-response", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: input })
          });

          const data = await response.json();
          typingMsg.textContent = data.reply || "Sorry, I couldn't get a response.";
        } catch (error) {
          typingMsg.textContent = "Error contacting Aditi.";
          console.error(error);
        }

        chatbox.scrollTop = chatbox.scrollHeight;
      });
    });

    // Profile menu toggle
    window.toggleProfileMenu = function () {
      const menu = document.getElementById("profileMenu");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    };
  </script>
</body>
</html>
