<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aditi - Pharmaceutical Assistant</title>
  <link rel="stylesheet" href="../static/css/styles.css" />
</head>
<body>
  <!-- Hide protected content until user is authenticated -->
  <div id="protectedContent" style="display: none;">
    <div class="container">
      <h1>Aditi - Your Pharmaceutical Assistant</h1>
      <div id="chatbox" class="message-container"></div>
      <div class="input-container">
        <input type="text" id="userInput" placeholder="Ask Aditi..." autofocus />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- Profile Button -->
    <div class="profile-container">
      <button id="profileButton" onclick="toggleProfileMenu()">Profile</button>
      <div id="profileMenu" class="profile-menu">
        <div>Name: &nbsp;<span id="loggedUserFName"></span>&nbsp;<span id="loggedUserLName"></span></div>
        <div>Email:&nbsp;<span id="loggedUserEmail"></span></div>
        <p></p>
        <button id="logout">Logout</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>

  <!-- Your Scripts -->
  <script src="../static/js/auth.js"></script>
  <script src="../static/js/main.js"></script>

  <!-- Firebase Initialization and Auth Check -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDa6_47neFJAH-I4i-ZCU0elY4cRmpyotg",
      authDomain: "aditi-pharmaceutical-assistant.firebaseapp.com",
      projectId: "aditi-pharmaceutical-assistant",
      storageBucket: "aditi-pharmaceutical-assistant.appspot.com",
      messagingSenderId: "241653252150",
      appId: "1:241653252150:web:ce83fa898dc2f77a669897",
      measurementId: "G-HMJ6SD9Q9H"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const docRef = doc(db, "users", user.uid);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const userData = docSnap.data();
            document.getElementById('loggedUserFName').innerText = userData.firstName || "";
            document.getElementById('loggedUserLName').innerText = userData.lastName || "";
            document.getElementById('loggedUserEmail').innerText = userData.email || "";
            document.getElementById("protectedContent").style.display = "block"; // show content
          } else {
            console.log("User data not found in Firestore.");
            window.location.href = "/";
          }
        } catch (error) {
          console.error("Error fetching user data:", error);
          window.location.href = "/";
        }
      } else {
        // Not logged in
        window.location.href = "/";
      }
    });

    // Logout
    document.addEventListener('DOMContentLoaded', () => {
      const logoutButton = document.getElementById('logout');
      if (logoutButton) {
        logoutButton.addEventListener('click', () => {
          signOut(auth)
            .then(() => {
              localStorage.removeItem('loggedInUserId');
              window.location.href = '/';
            })
            .catch((error) => {
              console.error("Error signing out:", error);
            });
        });
      }
    });
  </script>
</body>
</html>
